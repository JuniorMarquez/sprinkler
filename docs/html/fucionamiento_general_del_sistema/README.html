<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <title>Fucionamiento general del sistema | Introducción</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.0.3">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    
    <link rel="next" href="../funcionamiento_de_la_app_movil/README.html" />
    
    
    <link rel="prev" href="../index.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book"  data-level="1" data-basepath=".." data-revision="1435692898313">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         Introducción
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="1" data-path="fucionamiento_general_del_sistema/README.html">
            
                
                    <a href="../fucionamiento_general_del_sistema/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         Fucionamiento general del sistema
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="funcionamiento_de_la_app_movil/README.html">
            
                
                    <a href="../funcionamiento_de_la_app_movil/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         Funcionamiento de la app móvil
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3" data-path="funcionamiento_del_servidor/README.html">
            
                
                    <a href="../funcionamiento_del_servidor/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         Funcionamiento del servidor
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >Introducción</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_6528">
                    
                        <h1 id="fucionamiento-general-del-sistema">Fucionamiento general del sistema</h1>
<p>El sistema está compuesto por 3 elementos principales:</p>
<ul>
<li><strong>Dispositivo de grabación</strong>: graba y envía video al servidor.</li>
<li><strong>Servidor</strong>: trata y prepara el video para su distribución.</li>
<li><strong>Cliente</strong>: recibe y reproduce el video.</li>
</ul>
<p>El siguiente esquema esboza el funcionamiento del sistema:</p>
<p><img src="img/Workflow.svg" alt="Esquema"></p>
<ol>
<li>El dispositivo graba video (H264) y audio (AAC) con los encoders.</li>
<li>El video y audio se mezcla y organiza en el <code>FFmpegMuxer</code> al formato MPEG-TS apto para enviar video por internet mediante FFMPEG, que crea pequeños archivos <code>.ts</code>.</li>
<li>Cuando un archivo <code>.ts</code> es creado por FFMPEG, el <code>Broadcaster</code> lo detecta y lo sube al servidor mediante una POST HTTP chunked request.</li>
<li>El servidor inicia una instancia única de FFServer al iniciar.</li>
<li>Al conectar desde el dispositivo de grabación, el servidor crea una nueva instancia de FFMPEG.</li>
<li>El servidor procesa el video que va llegando en cada chunk.</li>
<li>Cuando ha leído un chunk, el servidor lo pasa a la instancia creada de FFMPEG.</li>
<li>Este FFMPEG hace demuxing de MPEG-TS y muxing a formato FFM.</li>
<li>Una vez hecho el remux del chunk, se envía al feed correcto del FFServer.</li>
<li>FFServer lee los datos de los feeds y hace re-encoding de estos a los formatos indicados en los <em>Streams</em> de su archivo de configuración <code>ffserver.conf</code>.</li>
<li>Cuando se conecta un cliente a FFServer, este empieza a server un feed con su configuración de stream correspondiente en tiempo real.</li>
</ol>
<h2 id="principales-problemas">Principales problemas</h2>
<ul>
<li><strong>Necesidad de Android 4.3 para la grabación</strong>: al usar clases de la API de Android 4.3 para la captura y procesado de video, es necesario que el dispositivo de grabación tenga una versión del SO mayor o igual a esta. Por este funcionamiento, además, es imposible hacer grabación de video en segundo plano. No parece haber una solución fácil a este problema.</li>
<li><strong>Delay</strong>: al usar HTTP Live Streaming para generar los archivos .ts existe el problema de que el archivo debe generarse antes de enviarse, teniendo un delay inicial igual al tiempo de grabación del archivo. A este delay hay que sumarle todos los demuxing, muxing, decoding y encoding a lo largo del sistema así como el tiempo de transmisión, lo cual puede dar lugar a un delay mínimo de 4-5s.</li>
</ul>
<p><em>Delay = tiempo_grabacion + ∑tiempos_transmision + ∑tiempos_tratamiento_video</em></p>
<ul>
<li><strong>Errores de conexión si hay un cliente conectado</strong>: se ha observado que en ciertas ocasiones, cuando hay un cliente aún conectado a un Stream de FFMPEG (que ya no emite) y se vuelven a empezar a transmitir los datos del Feed, la conexión con el servidor se pierde en el envío de los 2 primeros chunks. Probablemente sea un error de FFServer.</li>
<li><strong>Posibles errores de threading en dispositivo</strong>: el hilo de grabación de la cámara está en segundo plano con NDK y tiene que contactar frecuentemente con con otro hilo en primer plano mediante un <em>Handler</em>. Es posible que en algún momento uno de los 2 hilos haya sido cancelado y el Handler envíe un mensaje a un Thread que ya no funciona, ocasionando errores en la aplicación. Aunque en principio el error no se ha vuelto a observer desde que se implementó un bugfix, es posible que no esté solucionado del todo.</li>
<li><strong>Posibles errores de threading en servidor</strong>: al cerrar la aplicación o una conexión, el hilo encargado de dicha tarea debería cerrarse también. Aunque el servidor está implementado para que esto sea así, no se ha hecho un testeo exhaustivo que permita comprobar que no existen estos problemas en casos extremos.</li>
</ul>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../index.html" class="navigation navigation-prev " aria-label="Previous page: Introducción"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../funcionamiento_de_la_app_movil/README.html" class="navigation navigation-next " aria-label="Next page: Funcionamiento de la app móvil"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
